function _ssh_completion
{
  local cur bookmarked_hosts known_hosts
  cur="${COMP_WORDS[COMP_CWORD]}"
  if [ -r ~/.ssh/config ]; then
    bookmarked_hosts=$(/usr/bin/grep '^Host' ~/.ssh/config | cut -d ' ' -f 2)
  fi
  if [ -r ~/.ssh/known_hosts ]; then
    known_hosts=$(cut -d ' ' -f 1 < ~/.ssh/known_hosts | cut -d ',' -f 1)
  fi
  COMPREPLY=( $(compgen -W "${bookmarked_hosts} ${known_hosts}" -- "${cur}") )
}

complete -F _ssh_completion ssh
